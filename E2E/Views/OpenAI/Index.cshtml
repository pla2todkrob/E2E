@{
    ViewBag.Title = "Index";
}

@section scripts{
    <script>
        const apiKey = getCookie("OpenAI_Key");
        let chatHistory, chatLength, areaText;
        $(function () {
            reloadChatGPT();
        });

        async function appendChatHistory(inputText) {
            inputText = inputText.trim();
            let newItem = document.createElement("li");
            newItem.id = "qa-" + chatLength;
            let ul = null;

            if (chatHistory.children.length === 0 || chatHistory.lastElementChild.children[0].children.length === 2) {
                ul = document.createElement("ul");
                ul.classList.add("list-unstyled");
                newItem.appendChild(ul);
                chatHistory.appendChild(newItem);
            } else {
                ul = chatHistory.lastElementChild.children[0];
            }

            let li = document.createElement("li");

            let p = document.createElement("p");
            p.classList.add('text-prewrap');
            p.classList.add('p-2');
            p.classList.add('rounded');
            p.classList.add('mt-1');

            let small = document.createElement("small");
            small.innerHTML = new Date().toLocaleString();

            if (ul.children.length === 0) {
                p.classList.add('bg-primary');
                p.classList.add('text-white');
                p.innerHTML = inputText;
                li.appendChild(small);
                li.appendChild(p);
                li.classList.add("text-right");
                li.classList.add("pl-5");
            } else {
                p.classList.add('bg-light');
                p.innerHTML = inputText;
                li.appendChild(small);
                li.appendChild(p);
                li.classList.add("pr-5");
            }
            ul.appendChild(li);
        }

        function loadQuestion() {
            $.ajax({
                    url: '@Url.Action("Question","OpenAI")',
                    async: true,
                    method: 'GET'
                }).done(d2 => {
                    $('#questionSection').html(d2);
                    areaText = $('#Question');
                    areaText.focus();
                    areaText.keydown(function (e) {
                        if (e.keyCode == 13 && e.shiftKey) {
                            e.preventDefault();
                            $(this).val($(this).val() + "\n");
                        } else if (e.keyCode == 13) {
                            $('form').submit();
                        }
                    });
                    window.scrollTo({ top: $(document).height(), behavior: 'smooth' });
                });
        }

        $(document).on('submit', '#SaveQuestion', function (e) {
            e.preventDefault();
            appendChatHistory(areaText.val()).then(function () {
                $('#Question').val(areaText.val());
                $('#QuestionDateTime').val(new Date().toISOString());

                $.ajax({
                    type: "POST",
                    url: "https://api.openai.com/v1/engines/text-davinci-003/completions",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    async: true,
                    data: JSON.stringify({
                        prompt: areaText.val(),
                        max_tokens: 250,
                        stop: null,
                        temperature: 0.5
                    }),
                    success: function (res) {
                        console.log(res);
                        appendChatHistory(res.choices[0].text).then(function () {
                            $('#Answer').val(res.choices[0].text);
                            $('#AnswerDateTime').val(new Date().toISOString());
                            $.ajax({
                                url: '@Url.Action("Question","OpenAI")',
                                type: 'POST',
                                async: true,
                                processData: false,
                                contentType: false,
                                data: new FormData(document.getElementById('SaveQuestion')),
                                success: function (res2) {
                                    console.log(res2);
                                    loadQuestion();
                                },
                                error: function (error2) {
                                    console.error(error2);
                                }
                            });
                        });
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            });

            return false;
        });

        function reloadChatGPT() {
            $.ajax({
                url: '@Url.Action("History","OpenAI")',
                async: true,
                method: 'GET'
            }).done(d => {
                $('#historySection').html(d);
                chatHistory = document.getElementById("chatHistory");
                chatLength = document.querySelectorAll("li[id^='qa-']").length;
                loadQuestion();
            });
        }
    </script>
}

@section breadcrumb{
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index","Home")">Home</a></li>
            <li class="breadcrumb-item ">Chat bot</li>
        </ol>
    </nav>
}

<div class="card">
    <div class="card-header">
        <h4 class="card-title">Open AI</h4>
    </div>
    <div class="card-body" id="historySection"></div>
    <div class="card-footer" id="questionSection"></div>
</div>
